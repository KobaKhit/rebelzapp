<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>AI Chat â€¢ EduOrg</title>
	<link rel="stylesheet" href="/ui/styles.css" />
	<style>
		.chatbox{display:grid;gap:12px}
		.controls{display:flex;gap:8px;align-items:center}
		textarea{width:100%;min-height:90px}
	</style>
</head>
<body>
	<header>
		<h1>AI Chat</h1>
		<nav>
			<a href="/ui/index.html">Home</a>
			<a href="/ui/admin.html">Admin</a>
		</nav>
	</header>
	<main>
		<section class="panel">
			<div class="row" style="justify-content:space-between">
				<div class="badge">Model: <span id="modelName">auto</span></div>
				<button id="clearBtn" class="small">Clear</button>
			</div>
			<div id="messages" class="chat" aria-live="polite"></div>
			<div class="chatbox">
				<textarea id="input" class="input" placeholder="Ask about schedules, classes, events..."></textarea>
				<div class="controls">
					<button id="sendBtn">Send</button>
					<span class="small">Cmd/Ctrl+Enter to send</span>
				</div>
			</div>
		</section>
	</main>
	<script>
	const messagesEl = document.getElementById('messages');
	const inputEl = document.getElementById('input');
	const sendBtn = document.getElementById('sendBtn');
	const clearBtn = document.getElementById('clearBtn');
	const modelNameEl = document.getElementById('modelName');

	let history = [
		{ role: 'system', content: 'You are a helpful assistant for an education organization. Be concise.' }
	];

	function render(){
		messagesEl.innerHTML = '';
		history.forEach(m => {
			if(m.role === 'system') return;
			const div = document.createElement('div');
			div.className = 'msg ' + (m.role === 'user' ? 'user' : 'assistant');
			div.textContent = m.content;
			messagesEl.appendChild(div);
		});
		messagesEl.scrollTop = messagesEl.scrollHeight;
	}

	async function send(){
		const text = inputEl.value.trim();
		if(!text) return;
		inputEl.value = '';
		sendBtn.disabled = true;
		history.push({ role: 'user', content: text });
		render();
		try{
			const res = await fetch('/ai/chat', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ messages: history.filter(m => m.role !== 'system') })
			});
			if(!res.ok){ throw new Error('Request failed: ' + res.status); }
			const data = await res.json();
			modelNameEl.textContent = data.model || 'unknown';
			const choice = (data.choices && data.choices[0]) || {};
			const msg = choice.message || { role: 'assistant', content: '[no response]' };
			history.push(msg);
			render();
		} catch(err){
			console.error(err);
			alert('Chat error: ' + err.message);
		} finally {
			sendBtn.disabled = false;
			inputEl.focus();
		}
	}

	sendBtn.addEventListener('click', send);
	inputEl.addEventListener('keydown', (e)=>{
		if((e.ctrlKey || e.metaKey) && e.key === 'Enter') send();
	});
	clearBtn.addEventListener('click', ()=>{ history = history.slice(0,1); render(); });

	render();
	</script>
</body>
</html>
